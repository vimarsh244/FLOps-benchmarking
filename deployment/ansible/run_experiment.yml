---
# run distributed fl experiment

- name: Start FL Server
  hosts: servers
  become: false
  
  vars:
    repo_path: "{{ flops_repo_path | default('~/flops-benchmarking') }}"
    # note: hydra_overrides is passed via -e from the calling script, use directly with default filter
    experiment_overrides: "{{ hydra_overrides | default('') }}"
    hf_offline: "{{ flops_hf_offline | default(false) }}"
    # wandb configuration - set wandb_api_key in inventory or extra vars
    enable_wandb: "{{ wandb_enabled | default(true) }}"
    wandb_project_name: "{{ wandb_project | default('flops-benchmarking') }}"
    wandb_run_name: "{{ wandb_name | default('') }}"
    # Proxy configuration (set flops_proxy_url per-host/group in inventory if needed)
    proxy_url: "{{ flops_proxy_url | default('') }}"
    proxy_env:
      http_proxy: "{{ proxy_url }}"
      https_proxy: "{{ proxy_url }}"
      # Bypass proxy for local connections (Vagator2 IP)
      no_proxy: "10.1.19.113,localhost,127.0.0.1,::1,api.wandb.ai,wandb.ai"
      # Disable SSL Verify for Hugging Face downloads to bypass firewall cert issues
      HF_HUB_DISABLE_SSL_VERIFY: "1"
      CURL_CA_BUNDLE: ""
      HF_DATASETS_OFFLINE: "{{ '1' if hf_offline else '0' }}"
      HF_HUB_OFFLINE: "{{ '1' if hf_offline else '0' }}"
      # wandb config - set WANDB_API_KEY in your environment or inventory
      WANDB_API_KEY: "{{ wandb_api_key | default(lookup('env', 'WANDB_API_KEY')) }}"
      # use offline mode if no API key is provided
      WANDB_MODE: "{{ 'online' if (wandb_api_key is defined and wandb_api_key) or lookup('env', 'WANDB_API_KEY') else 'offline' }}"
  
  tasks:
    - name: Start Flower server
      shell: |
        cd {{ repo_path }}
        # Added -u for unbuffered output
        # LD_PRELOAD libgomp to fix "cannot allocate memory in static TLS block" on ARM
        LD_PRELOAD=/lib/aarch64-linux-gnu/libgomp.so.1 nohup {{ python_env }} -u -m src.run_distributed \
          hardware.run_mode=server \
          {{ experiment_overrides }} \
          > server.log 2>&1 &
        echo $!
      register: server_pid
      async: 10
      poll: 0
      # Apply proxy settings to the server process
      environment: "{{ proxy_env if proxy_url | length > 0 else {} }}"
      
    - name: Wait for server to start
      wait_for:
        host: "{{ ansible_host | default('0.0.0.0') }}"
        port: "{{ server_port | default(8080) }}"
        delay: 5
        timeout: 60
      register: server_check
      ignore_errors: yes

    - name: Check server log on failure
      command: "cat {{ repo_path }}/server.log"
      register: server_log_output
      when: server_check.failed
      
    - name: Show server log
      debug:
        var: server_log_output.stdout_lines
      when: server_check.failed

    - name: Fail if server did not start
      fail:
        msg: "Server failed to start. Check the log output above."
      when: server_check.failed
      
    - name: Display server info
      debug:
        msg: |
          Server started on {{ ansible_host | default('0.0.0.0') }}:{{ server_port | default(8080) }}
          To monitor server logs in real-time, SSH to server and run:
            tail -f {{ repo_path }}/server.log
          WandB mode: {{ 'online' if (wandb_api_key is defined and wandb_api_key) or lookup('env', 'WANDB_API_KEY') else 'offline' }}


- name: Start FL Clients
  hosts: clients
  become: false
  
  vars:
    repo_path: "{{ flops_repo_path | default('~/flops-benchmarking') }}"
    sync_code: "{{ flops_sync_code | default(false) }}"
    # Client runtime controls (override via inventory/group vars or -e)
    client_async_timeout: "{{ flops_client_async_timeout | default(86400) }}"  # 24h
    client_wait_retries: "{{ flops_client_wait_retries | default(8640) }}"  # 24h @ 10s
    # note: hydra_overrides is passed via -e from the calling script
    experiment_overrides: "{{ hydra_overrides | default('') }}"
    hf_offline: "{{ flops_hf_offline | default(false) }}"
    # Proxy configuration (set flops_proxy_url per-host/group in inventory if needed)
    proxy_url: "{{ flops_proxy_url | default('') }}"
    proxy_env:
      http_proxy: "{{ proxy_url }}"
      https_proxy: "{{ proxy_url }}"
      # Bypass proxy for local connections (Vagator2 IP)
      no_proxy: "10.1.19.113,localhost,127.0.0.1,::1"
      # Disable SSL verify specifically for Hugging Face
      HF_HUB_DISABLE_SSL_VERIFY: "1"
      CURL_CA_BUNDLE: ""
      HF_DATASETS_OFFLINE: "{{ '1' if hf_offline else '0' }}"
      HF_HUB_OFFLINE: "{{ '1' if hf_offline else '0' }}"
  
  tasks:
    - name: Synchronize code to client devices
      synchronize:
        src: "{{ repo_path }}"
        dest: "{{ repo_path }}"
        delete: yes
        rsync_opts:
          - "--exclude=.git"
          - "--exclude=__pycache__"
          - "--exclude=*.pyc"
          - "--exclude=outputs/"
          - "--exclude=.venv"
          - "--exclude=*.egg-info"
          - "--exclude=deployment" 
      delegate_to: localhost
      when: sync_code | bool

      
    - name: Start Flower client
      shell: |
        cd {{ repo_path }}
        # Uses server_address from inventory, defaults to localhost if missing
        # LD_PRELOAD libgomp to fix "cannot allocate memory in static TLS block" on ARM
        LD_PRELOAD=/lib/aarch64-linux-gnu/libgomp.so.1 {{ python_env }} -m src.run_distributed \
          hardware.run_mode=client \
          hardware.server_address={{ server_address | default('localhost:8080') }} \
          hardware.partition_id={{ partition_id }} \
          {{ experiment_overrides }} \
          > client_{{ partition_id }}.log 2>&1
      async: "{{ client_async_timeout | int }}"
      poll: 0
      register: client_job
      # Apply proxy settings to the client process
      environment: "{{ proxy_env if proxy_url | length > 0 else {} }}"
      
    - name: Display client info
      debug:
        msg: "Client {{ partition_id }} started on {{ inventory_hostname }}, connecting to {{ server_address | default('localhost:8080') }}"


- name: Wait for Experiment Completion
  hosts: clients
  become: false
  vars:
    client_wait_retries: "{{ flops_client_wait_retries | default(8640) }}"  # 24h @ 10s
  
  tasks:
    - name: Wait for client completion
      async_status:
        jid: "{{ client_job.ansible_job_id }}"
      register: job_result
      until: job_result.finished
      retries: "{{ client_wait_retries | int }}"
      delay: 10
      failed_when: false
      
    - name: Display completion status
      debug:
        msg: "Client {{ partition_id }} completed with status {{ job_result.rc | default('unknown') }}"


- name: Collect Server Results
  hosts: servers
  become: false
  
  vars:
    repo_path: "{{ flops_repo_path | default('~/flops-benchmarking') }}"
  
  tasks:
    - name: Read server log
      command: "cat {{ repo_path }}/server.log"
      register: server_final_log
      ignore_errors: yes
      
    - name: Display server log summary
      debug:
        msg: "{{ server_final_log.stdout_lines | default(['No server log found']) }}"
      
    - name: Extract round metrics from server log
      shell: "grep -E 'Round [0-9]+ metrics' {{ repo_path }}/server.log | tail -20"
      register: round_metrics
      ignore_errors: yes
      
    - name: Display final round metrics
      debug:
        msg: "{{ round_metrics.stdout_lines | default(['No round metrics found']) }}"
      when: round_metrics.stdout_lines | default([]) | length > 0
