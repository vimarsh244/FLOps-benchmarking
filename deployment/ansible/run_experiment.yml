---
# run distributed fl experiment

- name: Start FL Server
  hosts: servers
  become: false
  
  vars:
    repo_path: "{{ flops_repo_path | default('~/flops-benchmarking') }}"
    # Define Proxy Environment
    proxy_env:
      http_proxy: "http://10.8.1.221:8888"
      https_proxy: "http://10.8.1.221:8888"
      # CRITICAL FIX: Bypass proxy for local connections (Vagator2 IP)
      no_proxy: "10.8.1.221,localhost,127.0.0.1,::1"
      # Disable SSL Verify for Hugging Face downloads to bypass firewall cert issues
      HF_HUB_DISABLE_SSL_VERIFY: "1"
      CURL_CA_BUNDLE: ""
      HF_DATASETS_OFFLINE: "1"
      HF_HUB_OFFLINE: "1"
  
  tasks:
    - name: Start Flower server
      shell: |
        cd {{ repo_path }}
        # Added -u for unbuffered output
        nohup {{ python_env }} -u -m src.run_distributed server \
          --host {{ ansible_host | default('0.0.0.0') }} \
          --port {{ server_port | default(8080) }} \
          --num-rounds {{ num_rounds | default(50) }} \
          > server.log 2>&1 &
        echo $!
      register: server_pid
      async: 10
      poll: 0
      # Apply proxy settings to the server process
      environment: "{{ proxy_env }}"
      
    - name: Wait for server to start
      wait_for:
        host: "{{ ansible_host | default('0.0.0.0') }}"
        port: "{{ server_port | default(8080) }}"
        delay: 5
        timeout: 60
      register: server_check
      ignore_errors: yes

    - name: Check server log on failure
      command: "cat {{ repo_path }}/server.log"
      register: server_log_output
      when: server_check.failed
      
    - name: Show server log
      debug:
        var: server_log_output.stdout_lines
      when: server_check.failed

    - name: Fail if server did not start
      fail:
        msg: "Server failed to start. Check the log output above."
      when: server_check.failed
      
    - name: Display server info
      debug:
        msg: "Server started on {{ ansible_host | default('0.0.0.0') }}:{{ server_port | default(8080) }}"


- name: Start FL Clients
  hosts: clients
  become: false
  
  vars:
    repo_path: "{{ flops_repo_path | default('~/flops-benchmarking') }}"
    # Define Proxy Environment
    proxy_env:
      http_proxy: "http://10.8.1.221:8888"
      https_proxy: "http://10.8.1.221:8888"
      # CRITICAL FIX: Bypass proxy for local connections (Vagator2 IP)
      no_proxy: "10.8.1.221,localhost,127.0.0.1,::1"
      # Disable SSL verify specifically for Hugging Face
      HF_HUB_DISABLE_SSL_VERIFY: "1"
      CURL_CA_BUNDLE: ""
      HF_DATASETS_OFFLINE: "1"
      HF_HUB_OFFLINE: "1"
  
  tasks:
    - name: Start Flower client
      shell: |
        cd {{ repo_path }}
        # Uses server_address from inventory, defaults to localhost if missing
        {{ python_env }} -m src.run_distributed client \
          --server-address {{ server_address | default('localhost:8080') }} \
          --partition-id {{ partition_id }} \
          > client_{{ partition_id }}.log 2>&1
      async: 7200  # 2 hour timeout
      poll: 0
      register: client_job
      # Apply proxy settings to the client process
      environment: "{{ proxy_env }}"
      
    - name: Display client info
      debug:
        msg: "Client {{ partition_id }} started on {{ inventory_hostname }}, connecting to {{ server_address | default('localhost:8080') }}"


- name: Wait for Experiment Completion
  hosts: clients
  become: false
  
  tasks:
    - name: Wait for client completion
      async_status:
        jid: "{{ client_job.ansible_job_id }}"
      register: job_result
      until: job_result.finished
      retries: 720  # 2 hours at 10s intervals
      delay: 10
      
    - name: Display completion status
      debug:
        msg: "Client {{ partition_id }} completed with status {{ job_result.rc | default('unknown') }}"
