---
# run distributed fl experiment with hydra config overrides
# usage: ansible-playbook run_experiment_with_config.yml -i inventory.yml -e "hydra_overrides='strategy=diws partitioner=iid'"

- name: Start FL Server
  hosts: servers
  become: false
  
  vars:
    repo_path: "{{ flops_repo_path | default('~/flops-benchmarking') }}"
    # note: hydra_overrides is passed via -e from the calling script, use directly with default filter
    experiment_overrides: "{{ hydra_overrides | default('') }}"
    # wandb configuration - set wandb_api_key in inventory or extra vars
    enable_wandb: "{{ wandb_enabled | default(true) }}"
    wandb_project_name: "{{ wandb_project | default('flops-benchmarking') }}"
    wandb_run_name: "{{ wandb_name | default('') }}"
    # proxy environment
    proxy_env:
      http_proxy: "http://10.1.19.113:8888"
      https_proxy: "http://10.1.19.113:8888"
      no_proxy: "10.1.19.113,localhost,127.0.0.1,::1,api.wandb.ai,wandb.ai"
      HF_HUB_DISABLE_SSL_VERIFY: "1"
      CURL_CA_BUNDLE: ""
      HF_DATASETS_OFFLINE: "1"
      HF_HUB_OFFLINE: "1"
      WANDB_API_KEY: "{{ wandb_api_key | default(lookup('env', 'WANDB_API_KEY')) }}"
      WANDB_MODE: "{{ 'online' if (wandb_api_key is defined and wandb_api_key) or lookup('env', 'WANDB_API_KEY') else 'offline' }}"
  
  tasks:
    - name: Start Flower server with Hydra config
      shell: |
        cd {{ repo_path }}
        # run main.py with hardware=distributed and any additional overrides
        nohup {{ python_env }} -u -m src.main \
          hardware=distributed \
          {{ experiment_overrides }} \
          > server.log 2>&1 &
        echo $!
      register: server_pid
      async: 10
      poll: 0
      environment: "{{ proxy_env }}"
      
    - name: Wait for server to start
      wait_for:
        host: "{{ ansible_host | default('0.0.0.0') }}"
        port: "{{ server_port | default(8080) }}"
        delay: 5
        timeout: 60
      register: server_check
      ignore_errors: yes

    - name: Check server log on failure
      command: "cat {{ repo_path }}/server.log"
      register: server_log_output
      when: server_check.failed
      
    - name: Show server log
      debug:
        var: server_log_output.stdout_lines
      when: server_check.failed

    - name: Fail if server did not start
      fail:
        msg: "Server failed to start. Check the log output above."
      when: server_check.failed
      
    - name: Display server info
      debug:
        msg: |
          Server started on {{ ansible_host | default('0.0.0.0') }}:{{ server_port | default(8080) }}
          Config overrides: {{ experiment_overrides }}
          To monitor server logs in real-time, SSH to server and run:
            tail -f {{ repo_path }}/server.log
          WandB mode: {{ 'online' if (wandb_api_key is defined and wandb_api_key) or lookup('env', 'WANDB_API_KEY') else 'offline' }}


- name: Start FL Clients
  hosts: clients
  become: false
  
  vars:
    repo_path: "{{ flops_repo_path | default('~/flops-benchmarking') }}"
    sync_code: "{{ flops_sync_code | default(false) }}"
    # note: hydra_overrides is passed via -e from the calling script
    experiment_overrides: "{{ hydra_overrides | default('') }}"
    # proxy environment
    proxy_env:
      http_proxy: "http://10.1.19.113:8888"
      https_proxy: "http://10.1.19.113:8888"
      no_proxy: "10.1.19.113,localhost,127.0.0.1,::1"
      HF_HUB_DISABLE_SSL_VERIFY: "1"
      CURL_CA_BUNDLE: ""
      HF_DATASETS_OFFLINE: "1"
      HF_HUB_OFFLINE: "1"
  
  tasks:
    - name: Synchronize code to client devices
      synchronize:
        src: "{{ repo_path }}"
        dest: "{{ repo_path }}"
        delete: yes
        rsync_opts:
          - "--exclude=.git"
          - "--exclude=__pycache__"
          - "--exclude=*.pyc"
          - "--exclude=outputs/"
          - "--exclude=.venv"
          - "--exclude=*.egg-info"
          - "--exclude=deployment" 
      delegate_to: localhost
          when: sync_code | bool

      
    - name: Start Flower client with config
      shell: |
        cd {{ repo_path }}
        # clients run through main.py in distributed mode
        # the server/client distinction happens internally
        {{ python_env }} -m src.main \
          hardware=distributed \
          hardware.mode=client \
          hardware.server.host={{ server_address.split(':')[0] | default('localhost') }} \
          hardware.server.port={{ server_address.split(':')[1] | default('8080') }} \
          client.partition_id={{ partition_id }} \
          {{ experiment_overrides }} \
          > client_{{ partition_id }}.log 2>&1
      async: 28800  # 8hr timeout
      poll: 0
      register: client_job
      environment: "{{ proxy_env }}"
      
    - name: Display client info
      debug:
        msg: "Client {{ partition_id }} started on {{ inventory_hostname }}, connecting to {{ server_address | default('localhost:8080') }}"


- name: Wait for Experiment Completion
  hosts: clients
  become: false
  
  tasks:
    - name: Wait for client completion
      async_status:
        jid: "{{ client_job.ansible_job_id }}"
      register: job_result
      until: job_result.finished
      retries: 2880  # 8 hours at 10s intervals
      delay: 10
      failed_when: false
      
    - name: Display completion status
      debug:
        msg: "Client {{ partition_id }} completed with status {{ job_result.rc | default('unknown') }}"


- name: Collect Server Results
  hosts: servers
  become: false
  
  vars:
    repo_path: "{{ flops_repo_path | default('~/flops-benchmarking') }}"
  
  tasks:
    - name: Read server log
      command: "cat {{ repo_path }}/server.log"
      register: server_final_log
      ignore_errors: yes
      
    - name: Display server log summary
      debug:
        msg: "{{ server_final_log.stdout_lines | default(['No server log found']) }}"
      
    - name: Extract round metrics from server log
      shell: "grep -E 'Round [0-9]+ metrics' {{ repo_path }}/server.log | tail -20"
      register: round_metrics
      ignore_errors: yes
      
    - name: Display final round metrics
      debug:
        msg: "{{ round_metrics.stdout_lines | default(['No round metrics found']) }}"
      when: round_metrics.stdout_lines | default([]) | length > 0
